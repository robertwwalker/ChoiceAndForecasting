{
  "hash": "721901ab653f743faeaa74ced1d6cac1",
  "result": {
    "markdown": "---\ntitle: \"A Forecasting Example\"\nauthor: \"Robert W. Walker\"\ndate: \"2022-12-12\"\ncategories: [R]\nimage: \"image.png\"\ntoc: true\nexecute: \n  echo: fenced\n---\n\n\n\n\nI want to set up an example that runs completely from beginning to end working with stock market data establishing one approach to daily data.  The book shows what happens if we want to model trading days as a sequence that doesn't actually reflect time per se.  I want to take a different approach.  First, I will need some data.  Let me work with Apple's stock market data in OHLC format.  I can get these from `tidyquant`.\n\n\n::: {.cell hash='index_cache/html/unnamed-chunk-1_f3ee321164db2719abbf99f18a16b31d'}\n\n````{.cell-code}\n```{{r}}\nlibrary(tidyverse)\nlibrary(tidyquant)\nlibrary(fpp3)\n# Get Apple stock price\nAAPL <- tq_get(\"AAPL\")\n```\n````\n:::\n\n\nNow I need to create the full sequence of dates that includes days that markets are closed.  I want to left join the original data to this to get Apple's data on a complete set of calendar dates as `Full.Set`.\n\n\n::: {.cell hash='index_cache/html/unnamed-chunk-2_568662b6931d2c8c855d41119794cbd0'}\n\n````{.cell-code}\n```{{r}}\n# Create unpopulated calendar\ncalendar.set <- data.frame(date=seq.Date(from=min(AAPL$date), to=max(AAPL$date), by=\"1 day\"))\n# Join together the calendar and AAPL OHLC data\nFull.Set <- left_join(calendar.set, AAPL)\n# Create 5 day moving average to model using slider::slide_dbl\nlibrary(slider)\nFull.Set <- Full.Set %>% mutate(MA5 = slide_dbl(close, mean, na.rm=TRUE, .before=4)) %>% as_tsibble(index=date)\n```\n````\n:::\n\n\nFrom here, I can create a training set and a test set.\n\n\n::: {.cell hash='index_cache/html/unnamed-chunk-3_be3484d301b973b8848d8dd32831e559'}\n\n````{.cell-code}\n```{{r}}\n# Split a training set before November 30, 2022\nTrain <- Full.Set %>% filter(date < \"2022-11-30\") %>% as_tsibble(index=date)\nTest <- anti_join(Full.Set, Train) %>% as_tsibble(index=date)\n# Plot the whole thing\nFull.Set %>% autoplot(MA5)\n```\n````\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\nNow estimate two models.\n\n\n::: {.cell hash='index_cache/html/unnamed-chunk-4_5688eb4babbd7c5afb136e858e955c5d'}\n\n````{.cell-code}\n```{{r}}\nMods <- Train %>% model(AM5=ARIMA(MA5), ETS5=ETS(MA5))\nMods %>% glimpse()\nMods %>% glance()\n```\n````\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 1\nColumns: 2\n$ AM5  <model> [ARIMA(1,1,4)(0,0,1)[7] w/ drift]\n$ ETS5 <model> [ETS(M,Ad,N)]\n# A tibble: 2 × 11\n  .model    sigma2 log_lik    AIC   AICc    BIC ar_roots  ma_roots    MSE  AMSE\n  <chr>      <dbl>   <dbl>  <dbl>  <dbl>  <dbl> <list>    <list>    <dbl> <dbl>\n1 AM5    0.284      -2854.  5724.  5724.  5773. <cpl [1]> <cpl>    NA     NA   \n2 ETS5   0.0000447 -10610. 21231. 21231. 21268. <NULL>    <NULL>    0.331  1.17\n# … with 1 more variable: MAE <dbl>\n```\n:::\n:::\n\n\nAs we can see, the ARIMA is of a single difference with 1 AR and 4 MA terms as well as a 7 day seasonal moving average term.  The ETS contains no seasons, multiplicative errors, and additive trends.\n\n\n::: {.cell hash='index_cache/html/unnamed-chunk-5_f3df813284d8dd5492f670d3bd6ffa8b'}\n\n````{.cell-code}\n```{{r}}\n# Forecast for 30 days\nFC <- Mods %>% forecast(h=30)\n```\n````\n:::\n\n\nHow well does it do?\n\n\n::: {.cell hash='index_cache/html/unnamed-chunk-6_7e7db6456bc7d1b77c55e806f509a819'}\n\n````{.cell-code}\n```{{r}}\n# Model Assessment\naccuracy(FC, Test)\n```\n````\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 2 × 10\n  .model .type     ME  RMSE   MAE    MPE  MAPE  MASE RMSSE  ACF1\n  <chr>  <chr>  <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl> <dbl> <dbl>\n1 AM5    Test  -3.82   7.30  5.43 -2.94   4.04   NaN   NaN 0.914\n2 ETS5   Test   0.385  5.39  4.93  0.108  3.57   NaN   NaN 0.908\n```\n:::\n:::\n\n\nThe ETS model seems to do better on this test set.\n\n\n::: {.cell hash='index_cache/html/unnamed-chunk-7_73681cdc9fe5f023b4b1e11d0c2412d2'}\n\n````{.cell-code}\n```{{r}}\n# Show the forecast  needs alpha to see them\nPlot1 <- FC %>% autoplot(., alpha=0.2) + hrbrthemes::theme_ipsum_es() + labs(y=\"Forecast AAPL\")\nPlot1\n```\n````\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\nThe ETS bends lower and this better fits the data over the last 30 days.\n\n\n::: {.cell hash='index_cache/html/unnamed-chunk-8_fe7fbf8c13db59b34abe06fe91adc293'}\n\n````{.cell-code}\n```{{r}}\n# Show the forecast  needs alpha to see them\nPlot1 <- FC %>% autoplot(., alpha=0.4) + hrbrthemes::theme_ipsum_es() + labs(y=\"Forecast AAPL\") + geom_point(data=Test, aes(x=date, y=MA5), color=\"blue\", size=2, alpha=0.5) + guides(level=\"none\") \nPlot1\n```\n````\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n\nI don't really gain much from showing the whole training set.  It really is a lot of data.\n\n\n::: {.cell hash='index_cache/html/unnamed-chunk-9_4470de07685f5d4e3dd5e77938870001'}\n\n````{.cell-code}\n```{{r}}\n# Adapt the forecast to some data.\nPlot2 <- FC %>% autoplot(.) + geom_line(data=Train, aes(x=date, y=MA5)) + hrbrthemes::theme_ipsum_es() + labs(y=\"AAPL\")\nPlot2\n```\n````\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\nA bit more plotting.\n\n\n::: {.cell hash='index_cache/html/unnamed-chunk-10_ca7b778057eae5b2e5d4d9ef762b462f'}\n\n````{.cell-code}\n```{{r}}\nlibrary(patchwork)\n# Plot1 + Plot2\n# Zoomed in.\nD2021P <- Full.Set %>% filter(date > \"2022-10-01\")\nPlot2 <- FC %>% autoplot(., alpha=0.2) + geom_line(data=D2021P, aes(x=date, y=MA5)) + hrbrthemes::theme_ipsum_es() + labs(y=\"AAPL\") + guides(level=\"none\")\nPlot1 + Plot2\n```\n````\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\nShow it in zoom.\n\n\n::: {.cell hash='index_cache/html/unnamed-chunk-11_c5c7b5e8fc1627d3e96c5878965fcf63'}\n\n````{.cell-code}\n```{{r}}\nPlot2\n```\n````\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n# A Cross-Validation\n\n\n::: {.cell hash='index_cache/html/unnamed-chunk-12_d314fd63ad40431aedd4d26f3907b36d'}\n\n````{.cell-code}\n```{{r}}\napple_tr <- Full.Set %>%\n  stretch_tsibble(.init = 3350, .step = 30) %>%\n  relocate(date, .id)\napple_tr %>% model(AM5=ARIMA(MA5)) %>% \n  forecast(h=30) %>% \n  accuracy(Full.Set)\napple_tr %>% model(ETS5=ETS(MA5)) %>% \n  forecast(h=30) %>% \n  accuracy(Full.Set)\n```\n````\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 1 × 10\n  .model .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>  <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 AM5    Test  -3.68  10.8  8.52 -2.62  5.63  5.02  3.80 0.956\n# A tibble: 1 × 10\n  .model .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>  <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 ETS5   Test  -2.97  9.98  7.70 -2.16  5.15  4.54  3.50 0.959\n```\n:::\n:::\n\n\nThe ETS model seems to fit better across the cross-validated sets also.  Some forecasts on the data.\n\n\n::: {.cell hash='index_cache/html/unnamed-chunk-13_f6f0476459ecfb9dba39af330fc8fce8'}\n\n````{.cell-code}\n```{{r}}\nAFR <- apple_tr %>% model(AM5=ARIMA(MA5), ETS5=ETS(MA5)) %>% forecast(h=30)\n```\n````\n:::\n\n\nPutting all the data together requires a bit of manipulating.\n\n\n::: {.cell width='900px' height='600px' hash='index_cache/html/unnamed-chunk-14_0afed82a6350162fd669fdb491ff69c6'}\n\n````{.cell-code}\n```{{r, width=\"900px\", height=\"600px\"}}\nFS1 <- Full.Set %>% select(date, MA5) %>% mutate(Truth = MA5) %>% select(-MA5) %>% as_tsibble(index=date)\nAFR2 <- AFR %>% left_join(., FS1) %>% filter(.id<11)\nAFR2 %>% autoplot(alpha=0.7) + \nfacet_wrap(vars(.id), scales = \"free_x\") + hrbrthemes::theme_ipsum_rc() + guides(level=\"none\")\n```\n````\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n\nThis is a solid view of the forecasts.\n\n\n::: {.cell hash='index_cache/html/unnamed-chunk-15_152e26cd9224b67863f3c4c59743fb2d'}\n\n````{.cell-code}\n```{{r}}\nAFR2 %>% autoplot(alpha=0.5) +  facet_wrap(vars(.id), scales = \"free_x\") + hrbrthemes::theme_ipsum_rc() + guides(level=\"none\") + geom_line(data=AFR2, aes(x=date, y=Truth), size=1, alpha=0.2)\n```\n````\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n::: {.cell hash='index_cache/html/unnamed-chunk-16_4771d81f299dd89988ad39d4053be950'}\n\n````{.cell-code}\n```{{r}}\nAFR2 %>% filter(.id==1) %>% autoplot(alpha=0.5) + hrbrthemes::theme_ipsum_rc() + guides(level=\"none\") + geom_line(data={AFR2 %>% filter(.id==1)}, aes(x=date, y=Truth), size=1, alpha=0.2)\n```\n````\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n::: {.cell hash='index_cache/html/unnamed-chunk-17_d0bb1de23d26a3bb600135bdc0c7917e'}\n\n````{.cell-code}\n```{{r}}\nAFR2 %>% filter(.id==2) %>% autoplot(alpha=0.5) + hrbrthemes::theme_ipsum_rc() + guides(level=\"none\") + geom_line(data={AFR2 %>% filter(.id==2)}, aes(x=date, y=Truth), size=1, alpha=0.2)\n```\n````\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-17-1.png){width=672}\n:::\n:::\n\n::: {.cell hash='index_cache/html/unnamed-chunk-18_ae657c2975f9d9d07ed65a547d8b8c42'}\n\n````{.cell-code}\n```{{r}}\nAFR2 %>% filter(.id==3) %>% autoplot(alpha=0.5) + hrbrthemes::theme_ipsum_rc() + guides(level=\"none\") + geom_line(data={AFR2 %>% filter(.id==3)}, aes(x=date, y=Truth), size=1, alpha=0.2)\n```\n````\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n::: {.cell hash='index_cache/html/unnamed-chunk-19_1ddcb1207a8559645025804fcbad8fa6'}\n\n````{.cell-code}\n```{{r}}\nAFR2 %>% filter(.id==4) %>% autoplot(alpha=0.5) + hrbrthemes::theme_ipsum_rc() + guides(level=\"none\") + geom_line(data={AFR2 %>% filter(.id==4)}, aes(x=date, y=Truth), size=1, alpha=0.2)\n```\n````\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-19-1.png){width=672}\n:::\n:::\n\n::: {.cell hash='index_cache/html/unnamed-chunk-20_bfc8404e2183974d909cdd16050a4368'}\n\n````{.cell-code}\n```{{r}}\nAFR2 %>% filter(.id==5) %>% autoplot(alpha=0.5) + hrbrthemes::theme_ipsum_rc() + guides(level=\"none\") + geom_line(data={AFR2 %>% filter(.id==5)}, aes(x=date, y=Truth), size=1, alpha=0.2)\n```\n````\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-20-1.png){width=672}\n:::\n:::\n\n::: {.cell hash='index_cache/html/unnamed-chunk-21_4c2b10663828d375ea3beb0a937bd35a'}\n\n````{.cell-code}\n```{{r}}\nAFR2 %>% filter(.id==6) %>% autoplot(alpha=0.5) + hrbrthemes::theme_ipsum_rc() + guides(level=\"none\") + geom_line(data={AFR2 %>% filter(.id==6)}, aes(x=date, y=Truth), size=1, alpha=0.2)\n```\n````\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-21-1.png){width=672}\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}